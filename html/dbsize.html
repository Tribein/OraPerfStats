<html>
  <head>
	<meta charset="utf-8">
	<style>
.sbl-circ {
  height: 48px;
  width: 48px;
  color: #333333;
  position: relative;
  display: inline-block;
  border: 5px solid;
  border-radius: 50%;
  border-top-color: transparent;
  animation: rotate 1s linear infinite; }
@keyframes rotate {
  0% {
    transform: rotate(0); }
  100% {
    transform: rotate(360deg); } 
}		
.modal {
  display: none;
  position: fixed;
  z-index: 1;
  padding-top: 100px;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgb(0,0,0); 
  background-color: rgba(160,160,160,0.4); 
}
.modal-content {
  margin: auto;
  padding: 20px;
  border: 0px; 
  width: 60px;
}		
	</style>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
            google.charts.load('current', {'packages': ['corechart']});
            google.charts.load('current', {'packages': ['table']});
            //google.charts.load('current', {'packages':['bar']});
            google.charts.setOnLoadCallback(drawSizeChart);
            //--
            function getData(query) {
                var xmlHttp = new XMLHttpRequest();
                var xmlHttpOutput;
                xmlHttp.open("POST", 'http://apex.gksm.local:18123/ckh/?database=oradb&user=oracle&password=elcaro&query=', false);
                xmlHttp.send(query);
                return xmlHttp.responseText;
            }
            function a_getData(query,execfunc) {
                var xmlHttp = new XMLHttpRequest();
                var xmlHttpOutput;
                xmlHttp.open("POST", 'http://ogw.moscow.sportmaster.ru:18123/ckh', true);
                xmlHttp.send(query);
				xmlHttp.onreadystatechange = function() { 
					if (xmlHttp.readyState != 4) {return};
					if (xmlHttp.status != 200) {
						return;
					} else {
						execfunc(xmlHttp.responseText);
					}
				}                
            }                
			function showload(){
				document.getElementById("modalrg").innerHTML='<div id="spinner" class="modal"><div class="modal-content" align="center"><span class="sbl-circ"></span></div></div>';
				document.getElementById("spinner").style.display="block";
			}
			function hideload(){
				document.getElementById("spinner").style.display="none";
				document.getElementById("modalrg").innerHTML='';
			}            
            //--            
            var ts;
            var te;
            var timeSpan1;
            var timeSpan2;
            //--changable
            var spanMinutes = 20*1440;
            var dbUniqueName = 'DWH_M';
            var schema;
            var owner;
            var segment;
            //--------------------------------------------------------------
            function preDraw() {
                te = new Date();
                ts = new Date(te.getTime() - 1000 * 60 * spanMinutes);
                timeSpan1 = ts.getFullYear() + '-' +
                        ("0" + (ts.getMonth() + 1)).slice(-2) + '-' + ("0" + ts.getDate()).slice(-2)
                        + ' ' +
                        ("0" + ts.getHours()).slice(-2) + ':' + ("0" + ts.getMinutes()).slice(-2) + ':' + ("0" + ts.getSeconds()).slice(-2)
                        ;
                timeSpan2 = te.getFullYear() + '-' +
                        ("0" + (te.getMonth() + 1)).slice(-2) + '-' + ("0" + te.getDate()).slice(-2)
                        + ' ' +
                        ("0" + te.getHours()).slice(-2) + ':' + ("0" + te.getMinutes()).slice(-2) + ':' + ("0" + te.getSeconds()).slice(-2)
                        ;
            }
		//--------------------------------------------------------------
		function drawSizeChart(){
			preDraw();
			drawDBSizeChart();
		}
		//--------------------------------------------------------------
		function parseDBSizeData(inputData){
			var dataLines = inputData.split(/[\n]+/);
			var outData = [];
			var rowData = [];
			for (var i = 0; i < dataLines.length; i++) {
				if (dataLines[i].length > 0) {
					rowData = dataLines[i].split(/[\t]+/);
					outData.push([rowData[0]+" "+rowData[1]+":00:00", Number(rowData[2]), Number(rowData[3])]);
				}
			}
			return outData;
		}
		//--------------------------------------------------------------
		function parseSizeData(inputData){
			var dataLines = inputData.split(/[\n]+/);
			var outData = [];
			var rowData = [];
			for (var i = 0; i < dataLines.length; i++) {
				if (dataLines[i].length > 0) {
					rowData = dataLines[i].split(/[\t]+/);
					outData.push([rowData[0]+" "+rowData[1]+":00:00", Number(rowData[2])]);
				}
			}
			return outData;
		}		
		//--------------------------------------------------------------
		function parseSchemasSizeDiffData(inputData){
			var dataLines = inputData.split(/[\n]+/);
			var outData = [];
			var rowData = [];
			for (var i = 0; i < dataLines.length; i++) {
				if (dataLines[i].length > 0) {
					rowData = dataLines[i].split(/[\t]+/);
					outData.push([rowData[0],rowData[1]]);
				}
			}
			return outData;			
		}
		//--------------------------------------------------------------
		function parseSegmentsSizeDiffData(inputData){
			var dataLines = inputData.split(/[\n]+/);
			var outData = [];
			var rowData = [];
			for (var i = 0; i < dataLines.length; i++) {
				if (dataLines[i].length > 0) {
					rowData = dataLines[i].split(/[\t]+/);
					outData.push([((rowData[1].localeCompare("-")===0) ? rowData[0] : rowData[0] +"."+rowData[1]),rowData[2], Number(rowData[3])]);
				}
			}
			return outData;			
		}		
		//--------------------------------------------------------------
		function parseSegmentDetailsData(inputData){
			var dataLines = inputData.split(/[\n]+/);
			var outData = [];
			var rowData = [];
			for (var i = 0; i < dataLines.length; i++) {
				if (dataLines[i].length > 0) {
					rowData = dataLines[i].split(/[\t]+/);
					outData.push([rowData[0],rowData[1]]);
				}
			}
			return outData;			
		}		
		//--------------------------------------------------------------
        //------DBSIZE
        function drawDBSizeChart() {	
            var dbSizeQuery = "select st,hr,round(filesMb/1024),round(segmentsMb/1024) from ( "+
				"select toYYYYMMDD(snapTime) st,toHour(snapTime) hr, sum(sizeMb) as filesMb "+
					"from dbfiles_buffer "+
					"where dbuniquename='"+dbUniqueName+"' "+
					"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
					"and snapTime in ( "+
						"select min(snapTime) as st "+
						"from oradb.dbfiles_buffer "+
						"where dbuniquename='"+dbUniqueName+"' "+
						"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
						"group by toYYYYMMDD(snapTime), toHour(snapTime)    "+
					") "+
					"group by st,hr "+
				") any join ( "+
					"select toYYYYMMDD(snapTime) st,toHour(snapTime) hr, sum(sizeMb) as segmentsMb "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' "+
					"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
					"and snapTime in ( "+
						"select min(snapTime) as st "+
						"from oradb.segments_buffer  "+
						"where dbuniquename='"+dbUniqueName+"' "+
						"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
						"group by toYYYYMMDD(snapTime), toHour(snapTime)    "+
				") "+
				"group by st,hr "+
			") using (st,hr) order by st,hr";
			showload();
			a_getData(dbSizeQuery,drawDBSizeChart_);			
		}
        function drawDBSizeChart_(inputdata){	
			var drawRegion = "dbsizeregion";	
            showload();
            var data = new google.visualization.DataTable();
            //--add Columns
            data.addColumn('string', 'TimeStamp');
            data.addColumn('number', 'FilesSize');
            data.addColumn('number', 'SegmentsSize');
            //-- add Data
            data.addRows(parseDBSizeData(inputdata));
             var options = {
                 title: 'DB Size',
                 width: 1800,
                 height: 500,
                 hAxis: {textPosition: 'none'},
                 vAxis: {minValue: 0, format: '####'},
                 animation: {startup: 'false', duration: 10000},
                 //orientation : 'vertical',
                 legend: {position: 'bottom', maxLines: 1},
                 isStacked: false,
                 backgroundColor: {fill: 'transparent'},
                 pointSize: 1
             };
             var dbSizeChart = new google.visualization.AreaChart(document.getElementById(drawRegion));
             dbSizeChart.draw(data, options);
             hideload();
             drawSchemasSizeDiff();			
		}
		//------DBSIZE
		//------SCHEMASDIFF
		function drawSchemasSizeDiff(){
			var schemasSizeDiffQuery =  
				"select owner,round((seg2-seg1)/1024,0) as diff "+
				"from ( "+
					"select sum(sizeMb) as seg1, owner  "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' "+
					"and snapTime = ( "+
						"select min(snapTime) as st "+
						"from oradb.segments_buffer  "+
						"where dbuniquename='"+dbUniqueName+"' "+
						"and snapTime>='"+timeSpan1+"' "+
					") "+
					"group by owner "+
				") any full  join ( "+
					"select sum(sizeMb) as seg2, owner  "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' "+
					"and snapTime = ( "+
						"select max(snapTime) as st "+
						"from oradb.segments_buffer "+
						"where dbuniquename='"+dbUniqueName+"' "+
						"and snapTime<='"+timeSpan2+"' "+
				")		"+
				"group by owner "+
			") using (owner) "+
			"where diff<>0 "+
			"order by diff desc,owner";
			showload();
			a_getData(schemasSizeDiffQuery,drawSchemasSizeDiff_);			
		}
		function drawSchemasSizeDiff_(inputdata){
			var drawRegion = "schemasregion";
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Schema');
            data.addColumn('string', 'Size diff, Gb');
            data.addRows(parseSchemasSizeDiffData(inputdata));
            var options = {
                title: 'Schemas size difference for period',
                width: '98%',
                //height: '100%',
                allowHtml: true,
                showRowNumber: false,
                backgroundColor: {fill: 'transparent'}
            };
            var schemasSizeDiffTable = new google.visualization.Table(document.getElementById(drawRegion));
            schemasSizeDiffTable.draw(data, options);            
            hideload();

            function schemasSizeDiffTableHandler(e) {
                if (schemasSizeDiffTable.getSelection().length !== 0) {
                    var sel = schemasSizeDiffTable.getSelection();
                    drawSegmentsSizeDiff(data.getValue(sel[0].row, 0));
                    drawSchemaDetailsChart(data.getValue(sel[0].row, 0));
                    document.getElementById('schemadetailsregion').scrollIntoView();
                }
            }
            google.visualization.events.addListener(schemasSizeDiffTable, 'select', schemasSizeDiffTableHandler); 			
		}
		//------SCHEMASDIFF
		//------SCHEMADETAILS
		function drawSchemaDetailsChart( impschema ) {
			schema = inpschema;
            var dbSchemaDetailsQuery = "select toYYYYMMDD(snapTime) st,toHour(snapTime) hr, round(sum(sizeMb)/1024,3) "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' and owner='"+schema+"' " +
					"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
					"and snapTime in ( "+
						"select max(snapTime) as st "+
						"from oradb.segments_buffer  "+
						"where dbuniquename='"+dbUniqueName+"' "+
						"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
						"group by toYYYYMMDD(snapTime), toHour(snapTime)    "+
				") "+
				"group by st,hr order by st,hr";
			showload();	
			a_getData(dbSchemaDetailsQuery,drawSchemaDetailsChart_);	
		}
        function drawSchemaDetailsChart_( inputdata ) {
			var drawRegion = "schemadetailsregion";	

            var data = new google.visualization.DataTable();
            //--add Columns
            data.addColumn('string', 'TimeStamp');
            data.addColumn('number', 'SizeGb');
            //-- add Data
            data.addRows(parseSizeData(inputdata));
             var options = {
                 title: schema+" growth",
                 width: 1800,
                 height: 500,
                 hAxis: {textPosition: 'none'},
                 vAxis: {minValue: 0, format: '####'},
                 //orientation : 'vertical',
                 legend: {position: 'bottom', maxLines: 1},
                 isStacked: false,
                 backgroundColor: {fill: 'transparent'},
                 pointSize: 1
             };
             var dbSchemaDetailsChart = new google.visualization.LineChart(document.getElementById(drawRegion));
             dbSchemaDetailsChart.draw(data, options);
             hideload();
		}		
		//------SCHEMADETAILS
		//------SEGMENTSDIFF
		function drawSegmentsSizeDiff( inpowner ){
			owner = inpowner;
			var segmentsSizeDiffQuery = "select sn,pn,st,(sz2-sz1) as df "+
				"from ( "+
					"select segName as sn,partName as pn,segType as st,sizeMb as sz1 "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' and owner='"+owner+"' "+
					"and snapTime=( "+
						"select min(snapTime) from segments_buffer "+
						"where dbuniquename='"+dbUniqueName+"'  and snapTime>='"+timeSpan1+"' "+
					") " +
				") any full join ( "+
					"select segName as sn,partName as pn,segType as st,sizeMb as sz2 "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' and owner='"+owner+"' "+
					"and snapTime=( "+
						"select max(snapTime) from segments_buffer "+
						"where dbuniquename='"+dbUniqueName+"'  and snapTime<='"+timeSpan2+"' "+
					") "+
				") using (sn,pn,st) "+
				"where sz2<>sz1 "+
				"order by abs(df) desc";
			showload();	
			a_getData(segmentsSizeDiffQuery,drawSegmentsSizeDiff_);		
		}
		function drawSegmentsSizeDiff_( inputdata ){
			var drawRegion = "segmentsregion";

            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Segment');
            data.addColumn('string', 'Type');
            data.addColumn('number', 'Size diff, Mb');
            data.addRows(parseSegmentsSizeDiffData(inputdata));
            var options = {
                title: 'Segments size difference for '+owner,
                width: '100%',
                //height: '100%',
                //allowHtml: true,
                showRowNumber: false,
                backgroundColor: {fill: 'transparent'}
            };
            var segmentsSizeDiffTable = new google.visualization.Table(document.getElementById(drawRegion));
            segmentsSizeDiffTable.draw(data, options); 			
            hideload();
            
            function segmentsSizeDiffTableHandler(e) {
                if (segmentsSizeDiffTable.getSelection().length !== 0) {
                    var sel = segmentsSizeDiffTable.getSelection();
                    drawSegmentDetailsChart(owner,data.getValue(sel[0].row, 0));
                    document.getElementById('segmentdetailsregion').scrollIntoView();
                }
            }
            google.visualization.events.addListener(segmentsSizeDiffTable, 'select', segmentsSizeDiffTableHandler); 			            
		}
		//------SEGMENTSDIFF
		//------SEGMENTDETAILS
		function drawSegmentDetailsChart( inpowner, inpsegment){
			owner = inpowner;
			segment = (inpsegment.indexOf(".")<0)? inpsegment : inpsegment.substr(0,inpsegment.indexOf("."));
            var dbSegmentDetailsQuery = "select toYYYYMMDD(snapTime) st,toHour(snapTime) hr, sum(sizeMb) "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' and owner='"+owner+"' and segName='" +segment+ "' " +
					"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
					"and snapTime in ( "+
						"select max(snapTime) as st "+
						"from oradb.segments_buffer  "+
						"where dbuniquename='"+dbUniqueName+"' "+
						"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
						"group by toYYYYMMDD(snapTime), toHour(snapTime)    "+
				") "+
				"group by st,hr,segName order by st,hr";
			showload();			
			a_getData(dbSegmentDetailsQuery,drawSegmentDetailsChart_);
		}
		function drawSegmentDetailsChart_(inputdata){
			
			var drawRegion = "segmentdetailsregion";	

            var data = new google.visualization.DataTable();
            //--add Columns
            data.addColumn('string', 'TimeStamp');
            data.addColumn('number', 'SizeMb');
            //-- add Data
            data.addRows(parseSizeData(inputdata));
             var options = {
                 title: owner+'.'+segment+ ' growth'  ,
                 width: 1800,
                 height: 500,
                 hAxis: {textPosition: 'none'},
                 vAxis: {minValue: 0, format: '####'},
                 //orientation : 'vertical',
                 legend: {position: 'bottom', maxLines: 1},
                 isStacked: false,
                 backgroundColor: {fill: 'transparent'},
                 pointSize: 1
             };
             var dbSegmentDetailsChart = new google.visualization.LineChart(document.getElementById(drawRegion));
             dbSegmentDetailsChart.draw(data, options);
             hideload();
		}
		//------SEGMENTDETAILS
    </script>
  </head>

  <body onLoad=''>
	<div id="modalrg"></div>
	<div id="dbsizeregion"></div>
	<div id="schemasregion"></div>
	<div id="schemadetailsregion"></div>
	<div id="segmentsregion"></div>
	<div id="segmentdetailsregion"></div>
	<div id=""></div>
  </body>
</html>                        

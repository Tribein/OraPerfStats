<html>
  <head>
	<meta charset="utf-8">
	<style></style>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
            google.charts.load('current', {'packages': ['corechart']});
            google.charts.load('current', {'packages': ['table']});
            //google.charts.load('current', {'packages':['bar']});
            google.charts.setOnLoadCallback(drawDBSizeChart);
            //--
            function getData(query) {
                var xmlHttp = new XMLHttpRequest();
                var xmlHttpOutput;
                xmlHttp.open("POST", 'http://apex.gksm.local:18123/ckh/?database=oradb&user=oracle&password=elcaro&query=', false);
                xmlHttp.send(query);
                return xmlHttp.responseText;
            }
            //--            
            var ts;
            var te;
            var timeSpan1;
            var timeSpan2;
            //--changable
            var spanMinutes = 20*1440;
            var dbUniqueName = 'DWH_M';
            //--------------------------------------------------------------
            function preDraw() {
                te = new Date();
                ts = new Date(te.getTime() - 1000 * 60 * spanMinutes);
                timeSpan1 = ts.getFullYear() + '-' +
                        ("0" + (ts.getMonth() + 1)).slice(-2) + '-' + ("0" + ts.getDate()).slice(-2)
                        + ' ' +
                        ("0" + ts.getHours()).slice(-2) + ':' + ("0" + ts.getMinutes()).slice(-2) + ':' + ("0" + ts.getSeconds()).slice(-2)
                        ;
                timeSpan2 = te.getFullYear() + '-' +
                        ("0" + (te.getMonth() + 1)).slice(-2) + '-' + ("0" + te.getDate()).slice(-2)
                        + ' ' +
                        ("0" + te.getHours()).slice(-2) + ':' + ("0" + te.getMinutes()).slice(-2) + ':' + ("0" + te.getSeconds()).slice(-2)
                        ;
            }
		//--------------------------------------------------------------
		function parseDBSizeData(inputData){
			var dataLines = inputData.split(/[\n]+/);
			var outData = [];
			var rowData = [];
			for (var i = 0; i < dataLines.length; i++) {
				if (dataLines[i].length > 0) {
					rowData = dataLines[i].split(/[\t]+/);
					outData.push([rowData[0]+" "+rowData[1]+":00:00", Number(rowData[2]), Number(rowData[3])]);
				}
			}
			return outData;
		}
		//--------------------------------------------------------------
		function parseSizeData(inputData){
			var dataLines = inputData.split(/[\n]+/);
			var outData = [];
			var rowData = [];
			for (var i = 0; i < dataLines.length; i++) {
				if (dataLines[i].length > 0) {
					rowData = dataLines[i].split(/[\t]+/);
					outData.push([rowData[0]+" "+rowData[1]+":00:00", Number(rowData[2])]);
				}
			}
			return outData;
		}		
		//--------------------------------------------------------------
		function parseSchemasSizeDiffData(inputData){
			var dataLines = inputData.split(/[\n]+/);
			var outData = [];
			var rowData = [];
			for (var i = 0; i < dataLines.length; i++) {
				if (dataLines[i].length > 0) {
					rowData = dataLines[i].split(/[\t]+/);
					outData.push([rowData[0],rowData[1]]);
				}
			}
			return outData;			
		}
		//--------------------------------------------------------------
		function parseSegmentsSizeDiffData(inputData){
			var dataLines = inputData.split(/[\n]+/);
			var outData = [];
			var rowData = [];
			for (var i = 0; i < dataLines.length; i++) {
				if (dataLines[i].length > 0) {
					rowData = dataLines[i].split(/[\t]+/);
					outData.push([((rowData[1].localeCompare("-")===0) ? rowData[0] : rowData[0] +"."+rowData[1]),rowData[2], Number(rowData[3])]);
				}
			}
			return outData;			
		}		
		//--------------------------------------------------------------
		function parseSegmentDetailsData(inputData){
			var dataLines = inputData.split(/[\n]+/);
			var outData = [];
			var rowData = [];
			for (var i = 0; i < dataLines.length; i++) {
				if (dataLines[i].length > 0) {
					rowData = dataLines[i].split(/[\t]+/);
					outData.push([rowData[0],rowData[1]]);
				}
			}
			return outData;			
		}		
		//--------------------------------------------------------------
        //------DBSIZE
        function drawDBSizeChart() {
			preDraw();				
			var drawRegion = "dbsizeregion";	
            var dbSizeQuery = "select st,hr,round(filesMb/1024),round(segmentsMb/1024) from ( "+
				"select toYYYYMMDD(snapTime) st,toHour(snapTime) hr, sum(sizeMb) as filesMb "+
					"from dbfiles_buffer "+
					"where dbuniquename='"+dbUniqueName+"' "+
					"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
					"and snapTime in ( "+
						"select min(snapTime) as st "+
						"from oradb.dbfiles_buffer "+
						"where dbuniquename='"+dbUniqueName+"' "+
						"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
						"group by toYYYYMMDD(snapTime), toHour(snapTime)    "+
					") "+
					"group by st,hr "+
				") any join ( "+
					"select toYYYYMMDD(snapTime) st,toHour(snapTime) hr, sum(sizeMb) as segmentsMb "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' "+
					"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
					"and snapTime in ( "+
						"select min(snapTime) as st "+
						"from oradb.segments_buffer  "+
						"where dbuniquename='"+dbUniqueName+"' "+
						"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
						"group by toYYYYMMDD(snapTime), toHour(snapTime)    "+
				") "+
				"group by st,hr "+
			") using (st,hr) order by st,hr";
            //alert(dbSizeQuery);
            var data = new google.visualization.DataTable();
            //--add Columns
            data.addColumn('string', 'TimeStamp');
            data.addColumn('number', 'FilesSize');
            data.addColumn('number', 'SegmentsSize');
            //-- add Data
            data.addRows(parseDBSizeData(getData(dbSizeQuery)));
             var options = {
                 title: 'DB Size',
                 width: 1800,
                 height: 500,
                 hAxis: {textPosition: 'none'},
                 vAxis: {minValue: 0, format: '####'},
                 animation: {startup: 'true', duration: 1000},
                 bars: 'vertical',
                 //orientation : 'vertical',
                 bar: {groupWidth: '95%'},
                 legend: {position: 'right', maxLines: 3},
                 isStacked: false,
                 backgroundColor: {fill: 'transparent'},
                 pointSize: 1
             };
             var dbSizeChart = new google.visualization.AreaChart(document.getElementById(drawRegion));
             dbSizeChart.draw(data, options);
             drawSchemasSizeDiff();				
		}
		//------DBSIZE
		//------SCHEMASDIFF
		function drawSchemasSizeDiff() {
			var drawRegion = "schemasregion";
			var schemasSizeDiffQuery =  
				"select owner,round((seg2-seg1)/1024,0) as diff "+
				"from ( "+
					"select sum(sizeMb) as seg1, owner  "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' "+
					"and snapTime = ( "+
						"select min(snapTime) as st "+
						"from oradb.segments_buffer  "+
						"where dbuniquename='"+dbUniqueName+"' "+
						"and snapTime>='"+timeSpan1+"' "+
					") "+
					"group by owner "+
				") any full  join ( "+
					"select sum(sizeMb) as seg2, owner  "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' "+
					"and snapTime = ( "+
						"select max(snapTime) as st "+
						"from oradb.segments_buffer "+
						"where dbuniquename='"+dbUniqueName+"' "+
						"and snapTime<='"+timeSpan2+"' "+
				")		"+
				"group by owner "+
			") using (owner) "+
			"where diff<>0 "+
			"order by diff desc,owner";
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Schema');
            data.addColumn('string', 'Size diff, Gb');
            data.addRows(parseSchemasSizeDiffData(getData(schemasSizeDiffQuery)));
            var options = {
                title: 'Schemas size difference for period',
                width: '98%',
                //height: '100%',
                allowHtml: true,
                showRowNumber: false,
                backgroundColor: {fill: 'transparent'}
            };
            var schemasSizeDiffTable = new google.visualization.Table(document.getElementById(drawRegion));
            schemasSizeDiffTable.draw(data, options);            

            function schemasSizeDiffTableHandler(e) {
                if (schemasSizeDiffTable.getSelection().length !== 0) {
                    var sel = schemasSizeDiffTable.getSelection();
                    drawSegmentsSizeDiff(data.getValue(sel[0].row, 0));
                    drawSchemaDetailsChart(data.getValue(sel[0].row, 0));
                    document.getElementById('schemadetailsregion').scrollIntoView();
                }
            }
            google.visualization.events.addListener(schemasSizeDiffTable, 'select', schemasSizeDiffTableHandler); 			
		}
		//------SCHEMASDIFF
		//------SCHEMADETAILS
        function drawSchemaDetailsChart( schema ) {
			var drawRegion = "schemadetailsregion";	
            var dbSchemaDetailsQuery = "select toYYYYMMDD(snapTime) st,toHour(snapTime) hr, round(sum(sizeMb)/1024,3) "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' and owner='"+schema+"' " +
					"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
					"and snapTime in ( "+
						"select max(snapTime) as st "+
						"from oradb.segments_buffer  "+
						"where dbuniquename='"+dbUniqueName+"' "+
						"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
						"group by toYYYYMMDD(snapTime), toHour(snapTime)    "+
				") "+
				"group by st,hr order by st,hr";
            var data = new google.visualization.DataTable();
            //--add Columns
            data.addColumn('string', 'TimeStamp');
            data.addColumn('number', 'SizeGb');
            //-- add Data
            data.addRows(parseSizeData(getData(dbSchemaDetailsQuery)));
             var options = {
                 title: schema+" growth",
                 width: 1800,
                 height: 500,
                 hAxis: {textPosition: 'none'},
                 vAxis: {minValue: 0, format: '####'},
                 bars: 'vertical',
                 //orientation : 'vertical',
                 bar: {groupWidth: '95%'},
                 legend: {position: 'right', maxLines: 3},
                 isStacked: false,
                 backgroundColor: {fill: 'transparent'},
                 pointSize: 1
             };
             var dbSchemaDetailsChart = new google.visualization.LineChart(document.getElementById(drawRegion));
             dbSchemaDetailsChart.draw(data, options);
		}		
		//------SCHEMADETAILS
		//------SEGMENTSDIFF
		function drawSegmentsSizeDiff( owner ){
			var drawRegion = "segmentsregion";
			var segmentsSizeDiffQuery = "select sn,pn,st,(sz2-sz1) as df "+
				"from ( "+
					"select segName as sn,partName as pn,segType as st,sizeMb as sz1 "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' and owner='"+owner+"' "+
					"and snapTime=( "+
						"select min(snapTime) from segments_buffer "+
						"where dbuniquename='"+dbUniqueName+"'  and snapTime>='"+timeSpan1+"' "+
					") " +
				") any full join ( "+
					"select segName as sn,partName as pn,segType as st,sizeMb as sz2 "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' and owner='"+owner+"' "+
					"and snapTime=( "+
						"select max(snapTime) from segments_buffer "+
						"where dbuniquename='"+dbUniqueName+"'  and snapTime<='"+timeSpan2+"' "+
					") "+
				") using (sn,pn,st) "+
				"where sz2<>sz1 "+
				"order by abs(df) desc";
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Segment');
            data.addColumn('string', 'Type');
            data.addColumn('number', 'Size diff, Mb');
            data.addRows(parseSegmentsSizeDiffData(getData(segmentsSizeDiffQuery)));
            var options = {
                title: 'Segments size difference for '+owner,
                width: '98%',
                //height: '100%',
                allowHtml: true,
                showRowNumber: false,
                backgroundColor: {fill: 'transparent'}
            };
            var segmentsSizeDiffTable = new google.visualization.Table(document.getElementById(drawRegion));
            segmentsSizeDiffTable.draw(data, options); 			
            
            function segmentsSizeDiffTableHandler(e) {
                if (segmentsSizeDiffTable.getSelection().length !== 0) {
                    var sel = segmentsSizeDiffTable.getSelection();
                    drawSegmentDetailsChart(owner,data.getValue(sel[0].row, 0));
                    document.getElementById('segmentdetailsregion').scrollIntoView();
                }
            }
            google.visualization.events.addListener(segmentsSizeDiffTable, 'select', segmentsSizeDiffTableHandler); 			            
		}
		//------SEGMENTSDIFF
		//------SEGMENTDETAILS
		function drawSegmentDetailsChart( owner, inpsegment){
			var segment = (inpsegment.indexOf(".")<0)? inpsegment : inpsegment.substr(0,inpsegment.indexOf("."));
			var drawRegion = "segmentdetailsregion";	
            var dbSegmentDetailsQuery = "select toYYYYMMDD(snapTime) st,toHour(snapTime) hr, sum(sizeMb) "+
					"from segments_buffer "+
					"where dbuniquename='"+dbUniqueName+"' and owner='"+owner+"' and segName='" +segment+ "' " +
					"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
					"and snapTime in ( "+
						"select max(snapTime) as st "+
						"from oradb.segments_buffer  "+
						"where dbuniquename='"+dbUniqueName+"' "+
						"and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"' "+
						"group by toYYYYMMDD(snapTime), toHour(snapTime)    "+
				") "+
				"group by st,hr,segName order by st,hr";
			//alert(dbSegmentDetailsQuery);
            var data = new google.visualization.DataTable();
            //--add Columns
            data.addColumn('string', 'TimeStamp');
            data.addColumn('number', 'SizeMb');
            //-- add Data
            data.addRows(parseSizeData(getData(dbSegmentDetailsQuery)));
             var options = {
                 title: owner+'.'+segment+ ' growth'  ,
                 width: 1800,
                 height: 500,
                 hAxis: {textPosition: 'none'},
                 vAxis: {minValue: 0, format: '####'},
                 bars: 'vertical',
                 //orientation : 'vertical',
                 bar: {groupWidth: '95%'},
                 legend: {position: 'right', maxLines: 3},
                 isStacked: false,
                 backgroundColor: {fill: 'transparent'},
                 pointSize: 1
             };
             var dbSegmentDetailsChart = new google.visualization.LineChart(document.getElementById(drawRegion));
             dbSegmentDetailsChart.draw(data, options);
		}
		//------SEGMENTDETAILS
    </script>
  </head>

  <body onLoad=''>
	<div id="dbsizeregion"></div>
	<div id="schemasregion"></div>
	<div id="schemadetailsregion"></div>
	<div id="segmentsregion"></div>
	<div id="segmentdetailsregion"></div>
	<div id=""></div>
  </body>
</html>                        

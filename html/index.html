<html>
  <head>
	<meta charset="utf-8">
	<style>
	.ns{ letter-spacing: -2px; }
	.sc {  }
.sbl-circ {
  height: 48px;
  width: 48px;
  color: #333333;
  position: relative;
  display: inline-block;
  border: 5px solid;
  border-radius: 50%;
  border-top-color: transparent;
  animation: rotate 1s linear infinite; }
@keyframes rotate {
  0% {
    transform: rotate(0); }
  100% {
    transform: rotate(360deg); } 
}		
.modal {
  display: none;
  position: fixed;
  z-index: 1;
  padding-top: 100px;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgb(0,0,0); 
  background-color: rgba(160,160,160,0.4); 
}
.modal-content {
  margin: auto;
  padding: 20px;
  border: 0px; 
  width: 60px;
}			
	</style>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
            google.charts.load('current', {'packages': ['corechart']});
            google.charts.load('current', {'packages': ['table']});          
            google.charts.setOnLoadCallback(drawChart);
            var arrLocksTreeColumns = [
				'SID', 'Serial', 'User', 'Machine', 'Module', 'Program', 
				'Logon Time', 'SQLID', 'SQL Exec Start Time', 'Event', 
				'SEQUENCE', 'P1', 'P2', 
				'Blocking Session', 'Call Time', 'Wait Object'
			];
            var arrSessionTimeLineColumns = [
				'Time', 'SQLID', 'SQL Exec Start Time', 
				'Event', 'SEQUENCE', 'P1', 'P2', 
				'Blocking Session', 'Call Time', 'Wait Object',
				'EntObj','EntSubP','Obj','SubP',
				'PQ','PDML','PDDL'
			];
            var arrEventSessionsColumns = [
				'SID', 'Serial', 'User', 'Machine','Module','Program','Logon Time',
				'SQLID','SQL Start','Seq#','P1','P2',
				'Blocking Session','Call Time','Waito Object','ECID'
			];			
            var arrWaitClass = [
                'Timestamp',
                'System I/O',
                'User I/O',
                'Commit',
                'Network',
                'CPU',
                'Administrative',
                'Concurrency',
                'Application',
                'Configuration',
                'Queueing',
                'Scheduler',
                'Other'
            ];
            var arrWaitClassStyle = [
                '',
                'DeepSkyBlue',
                'Blue',
                'Orange',
                'Moccasin',
                'LimeGreen',
                'Silver',
                'DarkRed',
                'Red',
                'Sienna',
                'MistyRose',
                'PaleGreen',
                'Magenta'
            ];
            var arrClassNum = [12, 8, 9, 6, 7, 3, 0, 4, 2, 1, 11, 10];
            arrClassNum[127] = 5;
            var ts;
            var te;
            var timeSpan1;
            var timeSpan2;
            var eventsHeaderData;
            var eventsChart;
            var locksTreeTable;
            var statsTable;
            var eventSessionsTable;
            //--changable
            var spanMinutes = 10;
            var dbUniqueName = 'SHOP7771';
            var sessionsBlocked = 0;
            var classNum;
            var sid;
            var serial;
            var hostName = 'kis7771.moscow.sportmaster.ru';
            //--------------------------------------------------------------
            function checkClassNum(inp) {
                for (var i in arrClassNum) {
                    if (arrClassNum[i] === inp) {
                        return i;
                    }
                }
                return -1;
            }
            //--------------------------------------------------------------
			function unflatten(arr) {
                var tree = [], mappedArr = {}, arrElem, mappedElem;

                // First map the nodes of the array to an object -> create a hash table.
                for (var i = 0, len = arr.length; i < len; i++) {
                    arrElem = arr[i];
                    mappedArr[arrElem.id] = arrElem;
                    mappedArr[arrElem.id]['children'] = [];
                }

                for (var id in mappedArr) {
                    if (mappedArr.hasOwnProperty(id)) {
                        mappedElem = mappedArr[id];
                        // If the element is not at the root level, add it to its parent array of children.
                        if (mappedElem.parentid) {
								try{
									mappedArr[mappedElem.parentid]['children'].push(
										{ "id": mappedElem.id, "parentid": mappedElem.parentid, "children": mappedElem.children }
									);
                                }catch{}
                        tree.push(mappedElem);
                        }
                        // If the element is at the root level, add it to first level elements array.
                        else {
                            tree.push(mappedElem);
                        }
                    }
                }
                return tree;
            }
            //--------------------------------------------------------------
			function showload(){
				document.getElementById("modalrg").innerHTML='<div id="spinner" class="modal"><div class="modal-content" align="center"><span class="sbl-circ"></span></div></div>';
				document.getElementById("spinner").style.display="block";
			}
			function hideload(){
				if(document.getElementById("modalrg").innerHTML.length > 0 ){
					document.getElementById("spinner").style.display="none";
					document.getElementById("modalrg").innerHTML='';					
				}
			}                
            //--------------------------------------------------------------
            function preDraw() {
			/*
                te = new Date();
                ts = new Date(te.getTime() - 1000 * 60 * spanMinutes);
                timeSpan1 = ts.getFullYear() + '-' +
                        ("0" + (ts.getMonth() + 1)).slice(-2) + '-' + ("0" + ts.getDate()).slice(-2)
                        + ' ' +
                        ("0" + ts.getHours()).slice(-2) + ':' + ("0" + ts.getMinutes()).slice(-2) + ':' + ("0" + ts.getSeconds()).slice(-2)
                        ;
                timeSpan2 = te.getFullYear() + '-' +
                        ("0" + (te.getMonth() + 1)).slice(-2) + '-' + ("0" + te.getDate()).slice(-2)
                        + ' ' +
                        ("0" + te.getHours()).slice(-2) + ':' + ("0" + te.getMinutes()).slice(-2) + ':' + ("0" + te.getSeconds()).slice(-2)
                        ;
            */
				timeSpan1 = '2020-08-21 09:10:00';
				timeSpan2 = '2020-08-21 09:20:00';
            }
            function drawChart(){
				preDraw();
				drawWaitsChart();
			}
            //--------------------------------------------------------------            
			//--------------------------------------------------------------            
            function getDatefromSnapTime( ts ){
				var out = new Date(
					ts.substring(0,4), 
					Number(ts.substring(5,7))-1, 
					ts.substring(8,10), 
					ts.substring(11,13), 
					ts.substring(14,16), 
					ts.substring(17,20), 
					0
				).getTime();
				return out;
			}
            //--------------------------------------------------------------            
            //------WAITS
            function drawWaitsChart(){
				var waitsQuery = "select snapTime,classnum, count(1) val from sessions_buffer where dbuniquename='" + dbUniqueName + "' and hostname='"+hostName+"' " +
                    "and snapTime >= '" + timeSpan1 + "' and snapTime <= '" + timeSpan2 + "' group by snapTime,classnum order by snapTime asc";
                showload();
                a_getData(waitsQuery,drawWaitsChart_);
                drawLocksChart();
                drawSessionsTable();
                drawSQLsTable();                
			}
            function drawWaitsChart_(inputdata) {			
				var drawRegion = "waitsregion";

                var data = new google.visualization.DataTable();
                //--add Columns
                data.addColumn('string', arrWaitClass[0]);
                for (var i = 1; i < arrWaitClass.length; i++) {
                    data.addColumn('number', arrWaitClass[i]);
                    data.addColumn({type: 'string', role: "style"});
                }
                //-- add Data
                data.addRows(parseWaitsData(inputdata));
                var legendColors = [];
                for (var i = 1; i < arrWaitClass.length; i++) {
                    legendColors[i - 1] = arrWaitClassStyle[i];
                }
                var options = {
                    title: 'Wait Class',
                    width: 1800,
                    height: 500,
                    hAxis: {textPosition: 'none'},
                    vAxis: {minValue: 0, format: '####'},
                    animation: {startup: 'true', duration: 1000},
                    bars: 'vertical',
                    //orientation : 'vertical',
                    bar: {groupWidth: '95%'},
                    legend: {position: 'right', maxLines: 3},
                    colors: legendColors,
                    isStacked: true,
                    backgroundColor: {fill: 'transparent'}
                };
                var waitsChart = new google.visualization.ColumnChart(document.getElementById(drawRegion));
                waitsChart.draw(data, options);
                hideload();
                //--
                function waitsSelectHandler(e) {
                    if (waitsChart.getSelection().length === 0) {
                        if (typeof eventsChart !== 'undefined') {
                            eventsChart.clearChart();
                        }                     
                    } else {
                        if (typeof eventSessionsTable !== 'undefined') {
                            eventSessionsTable.clearChart();
                        }  						
                        var sel = waitsChart.getSelection();
                        if (typeof arrWaitClass[(Number(sel[0].column) + 1) / 2] !== 'undefined') {
                            drawEventsChart((Number(sel[0].column) + 1) / 2);
                            document.getElementById('eventsregion').scrollIntoView({block: "center", behavior: "smooth"});
                        }
                    }
                }
                google.visualization.events.addListener(waitsChart, 'select', waitsSelectHandler);
            }
            //------WAITS
            //------EVENTS
            function drawEventsChart(inpclassNum) {
                classNum = checkClassNum(inpclassNum);
                if (classNum < 0) {
                    return null;
                }				
                var eventsQuery = "select snapTime,event, count(1) val,classnum from sessions_buffer where dbuniquename='" + dbUniqueName + "' and hostname='"+hostName+"' " +
                        "and snapTime >= '" + timeSpan1 + "' and snapTime <= '" + timeSpan2 + "' group by snapTime,event,classnum order by snapTime asc, val asc";
                showload();	
                a_getData(eventsQuery,drawEventsChart_);			
			}
            function drawEventsChart_(inputdata) {
				var drawRegion = "eventsregion";
                var data = google.visualization.arrayToDataTable(parseEventsData(inputdata, Number(classNum)));
                if (data.getNumberOfRows() === 0) {
                    return;
                }                
                var options = {
                    title: 'Events',
                    width: 1800,
                    height: 500,
                    hAxis: {textPosition: 'none'},
                    vAxis: {minValue: 0, format: '####'},
                    animation: {startup: 'true', duration: 1000},
                    bars: 'vertical',
                    //orientation : 'vertical',
                    bar: {groupWidth: '95%'},
                    legend: {position: 'right', maxLines: 3},
                    isStacked: true,
                    backgroundColor: {fill: 'transparent'}
                };
                eventsChart = new google.visualization.ColumnChart(document.getElementById(drawRegion));
                eventsChart.draw(data, options);
                hideload();
                function eventsSelectHandler(e) {
                    if (eventsChart.getSelection().length === 0) {
                        if (typeof eventSessionsTable !== 'undefined') {
                            eventSessionsTable.clearChart();
                        }
                    } else {
                        var sel = eventsChart.getSelection();
                        drawEventSessions(data.getColumnLabel(sel[0].column),data.getValue(sel[0].row, 0));
                        document.getElementById('eventsessregion').scrollIntoView({block: "center", behavior: "smooth"});
                    }					
                }
                google.visualization.events.addListener(eventsChart, 'select', eventsSelectHandler);
            }
            //------EVENTS
            //------SESSIONSBYEVENTS
            function drawEventSessions (event,ts){
				var drawRegion = "eventsessregion";
				eventSessionsQuery = "select sid,serial,schemaname,machine,module,program,logon_time,toStringCutToZero(sql_id),sql_exec_start,seq,p1,p2,blocking_session,callEt,waitobj,ecid "+
						"from sessions_buffer " +
                        "where dbuniquename='" + dbUniqueName + "' and hostname='"+hostName+"' and snapTime='" + ts + "' and event='"+event+"' order by sid";
                showload();
                var data = google.visualization.arrayToDataTable(parseEventSessionsData(getData(eventSessionsQuery)));
                var options = {
                    title: 'Sessions by Event',
                    width: '100%',
                    //height: '100%',
                    allowHtml: true,
                    showRowNumber: false,
                    backgroundColor: {fill: 'transparent'},
                    cssClassNames: { tableCell: 'sc' }
                };
                eventSessionsTable = new google.visualization.Table(document.getElementById(drawRegion));
                eventSessionsTable.draw(data, options);
                hideload();

                function eventSessionsTableSelectHandler(e) {
                    if (eventSessionsTable.getSelection().length === 0) {
                    } else {
                        var sel = eventSessionsTable.getSelection();
                        /*
                        document.getElementById('sqltextregion').innerHTML = '<span style="font-family: monospace; font-size: large;"><b>'+
							data.getValue(sel[0].row, 7)+
							'</b>:<br />'+
							getSQLText(data.getValue(sel[0].row, 6)).replace(/\\n/g,'<br />')+
							'</span>';
						*/
                        drawStatsTable(data.getValue(sel[0].row, 0).match(/[0-9]+/)[0],data.getValue(sel[0].row, 1));
                        drawSessionTimeLine(data.getValue(sel[0].row, 0).match(/[0-9]+/)[0],data.getValue(sel[0].row, 1));
                    }
                }
                google.visualization.events.addListener(eventSessionsTable, 'select', eventSessionsTableSelectHandler);				
			}
            //------SESSIONSBYEVENTS
            //------LOCKSTREE
            function drawLocksTreeTable(input) {
                locksTreeQuery = "select sid,serial,schemaname,machine,module,program,logon_time,toStringCutToZero(sql_id),sql_exec_start,event,seq,p1,p2,blocking_session,callEt,waitobj from sessions_buffer " +
                        "where dbuniquename='" + dbUniqueName + "' and hostname='"+hostName+"' and snapTime='" + input + "' and (" +
                        "blocking_session<>0 or sid in (select blocking_session from sessions_buffer where dbuniquename='" + dbUniqueName + "' and snapTime='" + input + "') )";
                showload();
                a_getData(locksTreeQuery,drawLocksTreeTable_);				
			}
            function drawLocksTreeTable_(inputdata) {
				var drawRegion = "lockstreeregion";
                var data = google.visualization.arrayToDataTable(parseLocksTreeData(inputdata));
                var options = {
                    title: 'LocksTree',
                    width: '100%',
                    //height: '100%',
                    allowHtml: true,
                    showRowNumber: true,
                    backgroundColor: {fill: 'transparent'},
                    cssClassNames: { tableCell: 'sc' }
                };
                var locksTreeTable = new google.visualization.Table(document.getElementById(drawRegion));
                locksTreeTable.draw(data, options);
				hideload();
                function locksTreeSelectHandler(e) {
                    if (locksTreeTable.getSelection().length === 0) {
                        if (typeof statsTable !== 'undefined') {
                            statsTable.clearChart();
                        }
                    } else {
                        var sel = locksTreeTable.getSelection();
                        document.getElementById('sqltextregion').innerHTML = '<span style="font-family: monospace; font-size: large;"><b>'+
							data.getValue(sel[0].row, 7)+
							'</b>:<br />'+
							getSQLText(data.getValue(sel[0].row, 7)).replace(/\\n/g,'<br />')+
							'</span>';
                        drawStatsTable(data.getValue(sel[0].row, 0).match(/[0-9]+/)[0],data.getValue(sel[0].row, 1));
                        drawSessionTimeLine(data.getValue(sel[0].row, 0).match(/[0-9]+/)[0],data.getValue(sel[0].row, 1));
                    }
                }
                google.visualization.events.addListener(locksTreeTable, 'select', locksTreeSelectHandler);
            }
            //------LOCKSTREE            
            //------BLOCKINGS
            function drawLocksChart() {
                var locksQuery = "select snapTime, sum(if(blocking_session=0,0,1)) as val from sessions_buffer where dbuniquename='" + dbUniqueName + "' and hostname='"+hostName+"' " +
                        "and snapTime >= '" + timeSpan1 + "' and snapTime <= '" + timeSpan2 + "' group by snapTime order by snapTime asc";
                showload();	
                a_getData(locksQuery,drawLocksChart_);
			}
            function drawLocksChart_(inputdata) {
				var drawRegion = "locksregion";
                var data = new google.visualization.DataTable();
                data.addColumn('string', 'Timestamp');
                data.addColumn('number', 'Sessons blocked');
                data.addRows(parseLocksData(inputdata));
                var options = {
                    title: 'Blocking Sessions',
                    width: 1800,
                    height: 500,
                    hAxis: {textPosition: 'none'},
                    vAxis: {minValue: 0, format: '####'},
                    animation: {startup: 'true', duration: 1000},
                    bars: 'vertical',
                    //orientation : 'vertical',
                    bar: {groupWidth: '95%'},
                    legend: {position: 'right'},
                    isStacked: true,
                    backgroundColor: {fill: 'transparent'}
                };
                if (sessionsBlocked === 0) {
                    return;
                }
                var locksChart = new google.visualization.ColumnChart(document.getElementById(drawRegion));
                locksChart.draw(data, options);
                hideload();
                function locksSelectHandler(e) {
                    if (locksChart.getSelection().length === 0) {
                        if (typeof locksTreeTable !== 'undefined') {
                            locksTreeTable.clearChart();
                        }
                    } else {
                        var sel = locksChart.getSelection();
                        drawLocksTreeTable(data.getValue(sel[0].row, 0));
                        document.getElementById('lockstreeregion').scrollIntoView({block: "center", behavior: "smooth"});
                    }
                }
                google.visualization.events.addListener(locksChart, 'select', locksSelectHandler);
            }
            //------BLOCKINGS
            //------SESSIONS 
            function drawSessionsTable() {
                var sessionsQuery = "select " +
                        "sid,classnum,cnt,tot,ni,module,machine,schemaname,serial,sipHash64(concat(module,machine,schemaname,toString(serial),toString(sid))) as sessid" +
                        " from (select sid,serial,classnum,cnt,tot,machine,module,schemaname from (" +
                        "select sid,serial,module,machine,schemaname,classnum,count(1) as cnt,1 as dummy " +
                        "from sessions_buffer where classnum<>6 and dbuniquename='" + dbUniqueName + "' and hostname='"+hostName+"' and snapTime >= '" + timeSpan1 + "' and snapTime <= '" + timeSpan2 + "' " +
                        "group by sid,serial,module,machine,schemaname,classnum" +
                        ") all left join (" +
                        "select 1 as dummy,count(st) as tot from (select snapTime as st " +
                        "from sessions_buffer where dbuniquename='" + dbUniqueName + "' and hostname='"+hostName+"' and snapTime >= '" + timeSpan1 + "' and snapTime <= '" + timeSpan2 + "' " +
                        "group by st)" +
                        ") using dummy) all inner join (" +
                        "select sid,serial,module,machine,schemaname,ni from (" +
                        "select sid,serial,module,machine,schemaname,count(1) as ni " +
                        "from sessions_buffer where dbuniquename='" + dbUniqueName + "' and hostname='"+hostName+"' and snapTime >= '" + timeSpan1 + "' and snapTime <= '" + timeSpan2 + "' and classnum<>6 " +
                        "group by sid,serial,module,machine,schemaname having count(1)>0 order by ni desc" +
                        ") limit 20" +
                        ") using sid,serial,module,machine,schemaname " +
                        "order by ni desc,sid asc,cnt asc";
                showload();
                a_getData(sessionsQuery,drawSessionsTable_);				
			}
            function drawSessionsTable_(inputdata) {
				var drawRegion = "sessionsregion";

                var data = new google.visualization.DataTable();
                data.addColumn('string', 'SID,SERIAL');
                data.addColumn('string', 'SCHEMA');
                data.addColumn('string', 'MODULE@MACHINE');
                data.addColumn('string', 'WAITS');
                data.addRows(parseSessionsData(inputdata));
                var options = {
                    title: 'Sessions',
                    width: '48%',
                    //height: '100%',
                    allowHtml: true,
                    showRowNumber: false,
                    backgroundColor: {fill: 'transparent'},
                    cssClassNames: { tableCell: 'sc' }
                };
                var sessionsTable = new google.visualization.Table(document.getElementById(drawRegion));
                sessionsTable.draw(data, options);
				hideload();
                function sessionsSelectHandler(e) {
                    if (sessionsTable.getSelection().length === 0) {
                        if (typeof statsTable !== 'undefined') {
                            statsTable.clearChart();
                        }
                    } else {
                        var sel = sessionsTable.getSelection();
                        drawStatsTable(data.getValue(sel[0].row, 0).split(',')[0],data.getValue(sel[0].row, 0).split(',')[1]);
                        drawSessionTimeLine(data.getValue(sel[0].row, 0).split(',')[0],data.getValue(sel[0].row, 0).split(',')[1]);
                        //drawSessionSQLs(data.getValue(sel[0].row, 0).split(',')[0],data.getValue(sel[0].row, 0).split(',')[1]);
                    }
                }
                google.visualization.events.addListener(sessionsTable, 'select', sessionsSelectHandler);
            }
            //------SESSIONS  
            //------SQL 
            function drawSQLsTable() {
                var sqlsQuery = "select sqlid,sql_id,classnum,cnt,tot,ni from (select sqlid,sql_id,classnum,cnt,tot from (" +
                        "select sipHash64(toStringCutToZero(sql_id)) as sqlid, sql_id,classnum,count(1) as cnt, 1 as dummy " +
                        "from sessions_buffer where dbuniquename='" + dbUniqueName + "' and hostname='"+hostName+"' and snapTime >= '" + timeSpan1 + "' and snapTime <= '" + timeSpan2 + "' and toStringCutToZero(sql_id)<>'-' and classnum<>6 " +
                        "group by sqlid,sql_id,classnum" +
                        ") all left join (" +
                        "select 1 as dummy,count(st) as tot from (" +
						"select snapTime as st from sessions_buffer " +
                        "where toStringCutToZero(sql_id)<>'-' and dbuniquename='" + dbUniqueName + "' and hostname='"+hostName+"' and snapTime >= '" + timeSpan1 + "' and snapTime <= '" + timeSpan2 + "' " +
                        "group by snapTime)" +
                        ") using dummy) all inner join (" +
                        "select sql_id,ni from (" +
                        "select sql_id,count(1) as ni from sessions_buffer " +
                        "where classnum<>6 and toStringCutToZero(sql_id)<>'-' and dbuniquename='" + dbUniqueName + "' and hostname='"+hostName+"' and snapTime >= '" + timeSpan1 + "' and snapTime <= '" + timeSpan2 + "' " +
                        "group by sql_id having count(1)>0 order by ni desc" +
                        ") limit 20" +
                        ") using sql_id order by ni desc,sql_id,cnt asc";
                showload();	
                a_getData(sqlsQuery,drawSQLsTable_);			
			}
            function drawSQLsTable_(inputdata) {
				var drawRegion = "sqlsregion";

                var data = new google.visualization.DataTable();
                data.addColumn('string', 'SQL ID');
                data.addColumn('string', 'WAITS');
                data.addRows(parseSQLsData(inputdata));
                var options = {
                    title: 'SQL',
                    width: '48%',
                    //height: '100%',
                    allowHtml: true,
                    showRowNumber: false,
                    backgroundColor: {fill: 'transparent'},
                    cssClassNames: { tableCell: 'sc' }
                };
                var sqlsTable = new google.visualization.Table(document.getElementById(drawRegion));
                sqlsTable.draw(data, options);
                hideload();
                function sqlidSelectHandler(e) {
                    if (sqlsTable.getSelection().length === 0) {
                        if (typeof sqlsTable !== 'undefined') {
                            document.getElementById('sqltextregion').innerHTML='';
                        }
                    } else {
                        var sel = sqlsTable.getSelection();
                        document.getElementById('sqltextregion').innerHTML = '<span style="font-family: monospace; font-size: large;"><b>'+
							data.getValue(sel[0].row, 0)+
							'</b>:<br />'+
							getSQLText(data.getValue(sel[0].row, 0)).replace(/\\n/g,'<br />').replace(/\\\'/g,"'")+
							'</span>';
                        document.getElementById('sqltextregion').scrollIntoView({block: "center", behavior: "smooth"});
                    }
                }
                google.visualization.events.addListener(sqlsTable, 'select', sqlidSelectHandler);                
            }
            //------SQL
            //--STATS   
            function drawStatsTable(inpsid,inpserial) {
                if (typeof inpsid === 'undefined') {
                    return null;
                }				
				sid = inpsid;
				serial = inpserial;
                var statsQuery = "select statName,vl from ("+
							"select dbuniquename,statId,endvalue-beginvalue as vl from (" +
							"select dbuniquename,statId,value as beginvalue from sesstats_buffer where dbuniquename='" + dbUniqueName + "'  and snapTime = (" +
							"select min(snapTime) from sesstats_buffer where dbuniquename='" + dbUniqueName + "' and sid=" + sid + " and serial="+serial+" and snapTime>='" + timeSpan1 + "' and snapTime<='" + timeSpan2 + "'" +
							") and sid=" + sid + " and serial="+serial+
							") any inner join (" +
							"select dbuniquename,statId,value as endvalue from sesstats_buffer where dbuniquename='" + dbUniqueName + "'  and snapTime = (" +
							"select max(snapTime) from sesstats_buffer where dbuniquename='" + dbUniqueName + "' and sid=" + sid + " and serial="+serial+" and snapTime>='" + timeSpan1 + "' and snapTime<='" + timeSpan2 + "'" +
							") and sid=" + sid + " and serial="+serial+
							") using statId,dbuniquename where (endvalue-beginvalue)<>0 ) "+
							" any left join (select statId,statName from statnames_buffer where dbuniquename='" + dbUniqueName + "') using statId " +
							"order by vl desc";
				showload();
				a_getData(statsQuery,drawStatsTable_);				
			}         
            function drawStatsTable_(inputdata) {
				var drawRegion = "statsregion";
                var data = new google.visualization.DataTable();
                data.addColumn('string', 'Statistic for SID ' + sid);
                data.addColumn('number', 'Value diff');
                data.addRows(parseStatsData(inputdata));
                var options = {
                    width: '100%',
                    //height: '100%',
                    allowHtml: true,
                    showRowNumber: false,
                    backgroundColor: { fill: 'transparent' },
					cssClassNames: { tableCell: 'sc' }                    
                };
                statsTable = new google.visualization.Table(document.getElementById(drawRegion));
                statsTable.draw(data, options);
                hideload();
                document.getElementById(drawRegion).scrollIntoView({block: "center", behavior: "smooth"});
            }
            //--STATS
            //--SESSIONTIMELINE
            function drawSessionTimeLine(inpsid,inpserial){
				sid = inpsid;
				serial = inpserial;
				var SessionTimeLineQuery = "select snapTime,toStringCutToZero(sql_id),sql_exec_start,event,seq,p1,p2,blocking_session,callEt,waitobj,"+
						"plsqlEnObj,plsqlEtnSubP,plsqlObj,plsqlSubP,pq,pdml,pddl "+
						"from sessions_buffer " +
                        "where dbuniquename='" + dbUniqueName + "' and hostname='"+hostName+"' and snapTime>='" + timeSpan1 + "' and snapTime<='"+timeSpan2 +"' " +
                        "and sid="+sid+" and serial="+serial+" "+
                        "order by snapTime asc";	
                showload();			
                a_getData(SessionTimeLineQuery,drawSessionTimeLine_);	
			}
            function drawSessionTimeLine_(inputdata){
				var drawRegion = "sessiontimelineregion";
                var data = google.visualization.arrayToDataTable(parseSessionTimeLineData(inputdata));
                var options = {
                    title: "Session "+sid+","+serial+" timeline",
                    width: '100%',
                    //height: '100%',
                    allowHtml: true,
                    showRowNumber: true,
                    backgroundColor: {fill: 'transparent'},
                    cssClassNames: { tableCell: 'sc' }
                };
                var sessTimeLine = new google.visualization.Table(document.getElementById(drawRegion));
                sessTimeLine.draw(data, options);
                hideload();
                function sqlidSelectHandler(e) {
                    if (sessTimeLine.getSelection().length === 0) {
                        if (typeof sessTimeLine !== 'undefined') {
                            document.getElementById('sqltextregion').innerHTML='';
                        }
                    } else {
                        var sel = sessTimeLine.getSelection();
                        document.getElementById('sqltextregion').innerHTML = '<span style="font-family: monospace; font-size: large;"><b>'+
							data.getValue(sel[0].row, 1)+
							'</b>:<br />'+
							getSQLText(data.getValue(sel[0].row, 1)).replace(/\\n/g,'<br />').replace(/\\\'/g,"'")+
							'</span>';
                        document.getElementById('sqltextregion').scrollIntoView({block: "center", behavior: "smooth"});
                    }
                }
                google.visualization.events.addListener(sessTimeLine, 'select', sqlidSelectHandler);                 
			}
            //--SESSIONTIMELINE
            //--SESSIONSQLS            
            function drawSessionSQLs(inpsid,inpserial) {
				if (typeof inpsid === 'undefined') {
                    return null;
                }
                sid = inpsid;
                serial = inpserial;
                var SessionSQLsQuery = "select snapTime, "+
					"sipHash64(concat(toString(sql_id),toString(sql_exec_start))) as numid, "+
					"concat(toString(sql_id),concat(' (',concat(toString(sql_exec_start),')'))) as sql "+
					" from sessions_buffer where snapTime>='" + timeSpan1 + "' and snapTime<='" + timeSpan2 + "' and "+
					" dbuniquename='" + dbUniqueName + "' and hostname='"+hostName+"' and sid=" + sid + " and serial="+ serial + " and sql_id<>'-\0\0\0\0\0\0\0\0\0\0\0\0'"
					" order by sql_exec_start asc";
				showload();          
				a_getData(SessionSQLsQuery,drawSessionSQLs_);      
			}
            function drawSessionSQLs_(inputdata) {
				var drawRegion = "sessionsqlsregion";
                var data = new google.visualization.DataTable();
                data.addColumn({type: 'string', id: 'SQL'});
                data.addColumn({type: 'date', id: 'FirstSnapTime'});
				data.addColumn({type: 'date', id: 'LastSnapTime'});
				var tmpData = parseSessionSqlsData(inputdata);
				var ts1;
				var ts2;
				var tt;
				for (var i=0;i<tmpData.length; i++){
					ts1 = getDatefromSnapTime(tmpData[i][1]);
					ts2 = getDatefromSnapTime(tmpData[i][2]);
					if (ts2<ts1){
						tt=ts2;
						ts2=ts1;
						ts1=tt;
					}
					if (ts1 == ts2){
						ts2 = ts2+10000;
					}
					data.addRow(
						[
							tmpData[i][0],
							new Date(ts1),
							new Date(ts2)
						]
					);
				}
                var options = {
                    title: 'SQLs fo sesion '+inputsid+','+inputserial,
                    width: '100%',
                    height: 500,
                    backgroundColor: {fill: 'transparent'},         
                };
                data.sort([{column: 2}]);
                sessionSQLsChart = new google.visualization.Timeline(document.getElementById(drawRegion));
                sessionSQLsChart.draw(data,options);
                hideload();
                function sessSQLIdSelectHandler(e) {
                    if (sessionSQLsChart.getSelection().length !== 0) {
                        var sel = sessionSQLsChart.getSelection();
                        var sqlid  = data.getValue(sel[0].row, 0).split(' ')[0];
                        document.getElementById('sqltextregion').innerHTML = '<span style="font-family: monospace; font-size: large;"><b>'+
							sqlid+
							'</b>:<br />'+
							getSQLText(sqlid.replace(/\\n/g,'<br />').replace(/\\\'/g,"'"))+
							'</span>';
                        document.getElementById('sqltextregion').scrollIntoView({block: "center", behavior: "smooth"});
                    }
                }
                google.visualization.events.addListener(sessionSQLsChart, 'select', sessSQLIdSelectHandler);                 
             }
            //--SESSIONSQLS            
            //--SQLTEXT
            function getSQLText(sqlid){
				if(sqlid.length == 13){
					var sqlTextQuery = "select distinct sqltext from sqltexts_buffer where sqlid='"+sqlid+"'";
					var	sqltext = getData(sqlTextQuery);
					return sqltext;
				}else{
					return "Wrong SQLID"
				}
			}
            //--SQLTEXT
            //--
            function getData(query) {
                var xmlHttp = new XMLHttpRequest();
                var xmlHttpOutput;
                xmlHttp.open("POST", 'http://ogw.moscow.sportmaster.ru:18123/ckh', false); // false for synchronous request
                xmlHttp.send(query);
                return xmlHttp.responseText;
            }
            function a_getData(query,execfunc) {
                var xmlHttp = new XMLHttpRequest();
                var xmlHttpOutput;
                xmlHttp.open("POST", 'http://ogw.moscow.sportmaster.ru:18123/ckh', true);
                xmlHttp.send(query);
				xmlHttp.onreadystatechange = function() { 
					if (xmlHttp.readyState != 4) {return};
					if (xmlHttp.status != 200) {
						return;
					} else {
						execfunc(xmlHttp.responseText);
					}
				}                
            }               
            //--
            function parseEventsData(inputData, classNum) {
                //--
                function searchHeader(inp) {
                    for (var hi in eventsHeaderData) {
                        if (eventsHeaderData[hi] === inp) {
                            return hi;
                        }
                    }
                    return -1;
                }
                var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var tmpData = [];
                var rowData = [];
                eventsHeaderData = ['Timestamp'];
                var idx;
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        if (searchHeader(rowData[1]) === -1 && Number(rowData[3]) === classNum) {
                            eventsHeaderData[eventsHeaderData.length] = rowData[1];
                        }
                    }
                }
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        idx = Number(rowData[0].replace(/[:-\s]/g, ""));
                        if (typeof tmpData[idx] === 'undefined') {
                            tmpData[idx] = [];
                            tmpData[idx][0] = String(rowData[0]);
                            for (var ti = 1; ti < eventsHeaderData.length; ti++) {
                                tmpData[idx][ti] = 0;
                            }
                        }
                        if (Number(rowData[3]) === classNum) {
                            tmpData[idx][searchHeader(rowData[1])] = Number(rowData[2]);
                        }
                    }
                }
                outData.push(eventsHeaderData);
                for (var ei in tmpData) {
                    outData.push(tmpData[ei]);
                }
                return outData;
            }
            //--
            function parseSessionSqlsData(inputData) {
                var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var tmpData = [];
                var rowData = [];
                var tmpIdx = [];
                var k = 0;
                var idx;                
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        idx = Number(rowData[1]);
                        if (typeof tmpIdx[idx] === 'undefined') {
                            tmpIdx[idx] = k;
                            tmpData[k] = [rowData[2], rowData[0], rowData[0]];
                            k++;
                        } else {
                            tmpData[tmpIdx[idx]][2] = rowData[0];
                        }
                    }
                }
                for (var si in tmpData) {
                    outData.push(tmpData[si]);
                }                
                return outData;
            }            
            //--
            function parseWaitsData(inputData) {
                var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var tmpData = [];
                var rowData = [];
                var idx;
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        idx = Number(rowData[0].replace(/[:-\s]/g, ""));
                        if (typeof tmpData[idx] === 'undefined') {
                            tmpData[idx] = [rowData[0], 0, "", 0, "", 0, "", 0, "", 0, "", 0, "", 0, "", 0, "", 0, "", 0, "", 0, "", 0, ""];
                        }
                        if (Number(rowData[1]) !== 6) {
                            tmpData[idx][arrClassNum[Number(rowData[1])] * 2 - 1] = Number(rowData[2]);
                            tmpData[idx][arrClassNum[Number(rowData[1])] * 2] = arrWaitClassStyle[arrClassNum[Number(rowData[1])]];
                        }
                    }
                }
                for (var wi in tmpData) {
                    outData.push(tmpData[wi]);
                }
                return outData;
            }
            //--
            //--
            function parseStatsData(inputData) {
                var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var rowData = [];
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        outData.push([rowData[0], Number(rowData[1])]);
                    }
                }
                return outData;
            }
            //--            
            function parseLocksData(inputData) {
                var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var tmpData = [];
                var rowData = [];
                var idx;
                sessionsBlocked = 0;
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        idx = Number(rowData[0].replace(/[:-\s]/g, ""));
                        tmpData[idx] = [rowData[0], Number(rowData[1])];
                        if (sessionsBlocked === 0 && Number(rowData[1]) !== 0) {
                            sessionsBlocked = 1;
                        }
                    }
                }
                for (var li in tmpData) {
                    outData.push(tmpData[li]);
                }
                return outData;
            }
            //--
            function colorPercentWait(current, total, classnum, nonidle) {
                var out = '<font class="ns" title="' + arrWaitClass[arrClassNum[classnum]] + " " + (Math.round(100 * current / total)) + '%" color="' + arrWaitClassStyle[arrClassNum[classnum]] + '">';
                var maxchars = 100;// * Math.ceil(nonidle / total);
                for (var i = 0; i < Math.ceil(maxchars * current / total); i++) {
                    out += "█";
                }
                out += '</font>';
                return out;
            }
            //--
            function parseSessionsData(inputData) {
                var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var tmpData = [];
                var rowData = [];
                var tmpIdx = [];
                var k = 0;
                var idx;
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        idx = Number(rowData[9]);
                        if (typeof tmpIdx[idx] === 'undefined') {
                            tmpIdx[idx] = k;
                            tmpData[k] = [rowData[0] + "," + rowData[8], rowData[7], rowData[5] + "@" + rowData[6], colorPercentWait(rowData[2], rowData[3], rowData[1], rowData[4])];
                            k++;
                        } else {
                            tmpData[tmpIdx[idx]][3] = tmpData[tmpIdx[idx]][3] + colorPercentWait(rowData[2], rowData[3], rowData[1], rowData[4]);
                        }
                    }
                }
                for (var si in tmpData) {
                    outData.push(tmpData[si]);
                }
                return outData;
            }
            //--
            //--
            function parseSQLsData(inputData) {
                var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var tmpData = [];
                var rowData = [];
                var tmpIdx = [];
                var k = 0;
                var idx;
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        idx = Number(rowData[0]);
                        if (typeof tmpIdx[idx] === 'undefined') {
                            tmpIdx[idx] = k;
                            tmpData[k] = [rowData[1], colorPercentWait(rowData[3], rowData[4], rowData[2], rowData[5])];
                            k++;
                        } else {
                            tmpData[tmpIdx[idx]][1] = tmpData[tmpIdx[idx]][1] + colorPercentWait(rowData[3], rowData[4], rowData[2], rowData[5]);
                        }
                    }
                }
                for (var si in tmpData) {
                    outData.push(tmpData[si]);
                }
                return outData;
            }
            //--
			function parseLocksTreeData(inputData) 
            {
                var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var tmpData = [];
                var tmpData2 = [];
                var rowData = [];
                var idx = 0;
                var r = 0;
				var sidx = 0;
				var flag;
                var arrTree = [];
				var arr_test = [];
				var arr_permitted_branches = [];
                var arrSIDSorted = [];
                var arrSIDLevel = [];
				var arrBranchID = [];
				var data;
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        idx = Number(rowData[0]);
                        tmpData[idx] = [];
                        for (var j = 0; j < arrLocksTreeColumns.length; j++) {
                            tmpData[idx][j] = rowData[j];
                        }
                        arrTree.push({"id": Number(rowData[0]), "parentid": Number(rowData[13])});
                    }
                }
                //--
                arrTree = unflatten(arrTree);
                function recGetSID(input, level) {
					if (level == 0) {
						sidx++;
						arr_test = [];
						flag = 0;
					}else {
						null;
					}
                    if (input.parentid == 0){
                        arr_permitted_branches.push(sidx);
                    }
					arrSIDSorted.push(Number(input.id));
					arrSIDLevel.push(level);
					arrBranchID.push(sidx);
					arr_test.push(Number(input.id));
					if (input.children.length > 0) {
						level++;
						for (var s in input.children) {
							if (arr_test.includes(input.children[s].id)){
								if (flag == 0){
									flag = 1;
									//console.log(input.children[s]);
									recGetSID(input.children[s], level);
								}else {
									arr_permitted_branches.push(sidx);
									return;
								}
							} else {
								recGetSID(input.children[s], level);
							} 
						}
					}
                }
                //--
                for (var i in arrTree) {
                    recGetSID(arrTree[i], 0);
                }
                //--
                outData.push(arrLocksTreeColumns);
                for (var i = 0; i < arrSIDSorted.length; i++) {
                    if (arr_permitted_branches.includes(arrBranchID[i]) ) {
                        r++;
                        tmpData2[r] = [];
                        for (var j = 0; j < arrLocksTreeColumns.length; j++) {
                            tmpData2[r][j] = tmpData[arrSIDSorted[i]][j];
                        }
                        if (arrSIDLevel[i] == 0) {
                            tmpData2[r][0] = '<strong>' + tmpData2[r][0] + '</strong>';
                            
                        }else{
                            for (var j = 0; j < arrSIDLevel[i]; j++) {
                                tmpData2[r][0] = '&nbsp;&nbsp;&nbsp;&nbsp;' + tmpData2[r][0];
                            }
                        }
                        outData.push(tmpData2[r]);
                    }
                }   
                return outData;
            }
            //--
            function parseSessionTimeLineData(inputData) {
                var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var tmpData = [];
                var rowData = [];
                var idx;
                var arrTree = [];
                var arrSIDSorted = [];
                var arrSIDLevel = [];
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        tmpData[i] = [];
                        for (var j = 0; j < arrSessionTimeLineColumns.length; j++) {
                            tmpData[i][j] = rowData[j];
                        }
                    }
                }
                outData.push(arrSessionTimeLineColumns);
                for (var i = 0; i < tmpData.length; i++) {
                    outData.push(tmpData[i]);
                }
                return outData;
            }
            //--            
            function parseEventSessionsData(inputData) {
                var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var tmpData = [];
                var rowData = [];
                var idx;
                var arrTree = [];
                var arrSIDSorted = [];
                var arrSIDLevel = [];
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        tmpData[i] = [];
                        for (var j = 0; j < arrEventSessionsColumns.length; j++) {
                            tmpData[i][j] = rowData[j];
                        }
                    }
                }
                outData.push(arrEventSessionsColumns);
                for (var i = 0; i < tmpData.length; i++) {
                    outData.push(tmpData[i]);
                }
                return outData;
            }
            //--              
 
    </script>
  </head>

  <body onLoad=''>
	<div id="modalrg"></div>  
    <div id="waitsregion"></div>
    <div id="eventsregion"></div>
    <div id="eventsessregion"></div>
    <div id="locksregion"></div>
    <div id="lockstreeregion"></div>
    <div id="sqltextregion"></div>
    <div>
		<span id="sqlsregion"></span>
		&nbsp;
		<span id="sessionsregion"></span>
	</div>
	<div id="statsregion"></div>
	<div id="sessionsqlsregion"></div>
	<div id="sessiontimelineregion"></div>
  </body>
</html>

<html>
  <head>
	<meta charset="utf-8">
	<style></style>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
            google.charts.load('current', {'packages': ['corechart']});
            //google.charts.load('current', {'packages': ['table']});
            //google.charts.load('current', {'packages':['bar']});
            google.charts.setOnLoadCallback(drawBasicCharts);
            //--
            function getData(query) {
                var xmlHttp = new XMLHttpRequest();
                var xmlHttpOutput;
                xmlHttp.open("POST", 'http://apex.gksm.local:18123/ckh/?database=oradb&user=oracle&password=elcaro&query=', false);
                xmlHttp.send(query);
                return xmlHttp.responseText;
            }
            //--            
            var ts;
            var te;
            var timeSpan1;
            var timeSpan2;
            //--changable
            var spanMinutes = 5;
            var dbUniqueName = 'sefarm_prd';
            //--------------------------------------------------------------
            function preDraw() {
                te = new Date();
                ts = new Date(te.getTime() - 1000 * 60 * spanMinutes);
                timeSpan1 = ts.getFullYear() + '-' +
                        ("0" + (ts.getMonth() + 1)).slice(-2) + '-' + ("0" + ts.getDate()).slice(-2)
                        + ' ' +
                        ("0" + ts.getHours()).slice(-2) + ':' + ("0" + ts.getMinutes()).slice(-2) + ':' + ("0" + ts.getSeconds()).slice(-2)
                        ;
                timeSpan2 = te.getFullYear() + '-' +
                        ("0" + (te.getMonth() + 1)).slice(-2) + '-' + ("0" + te.getDate()).slice(-2)
                        + ' ' +
                        ("0" + te.getHours()).slice(-2) + ':' + ("0" + te.getMinutes()).slice(-2) + ':' + ("0" + te.getSeconds()).slice(-2)
                        ;
            }
            //----------------------------------------------------------------
            function parseIOFunctionStatsData(inputData) {
                var dataLines = inputData.split(/[\n]+/);
                var outData1 = [];
				var outData2 = [];
				var outData  = [];
                var rowData = [];
				var hdrData = [];
				var tmpTS = "";
				var hdrIdx = 1;
				var dataIdx = 0;
				var firstSet = true;
				var prevRow1 = [];
				var prevRow2 = [];
				hdrData[0] = 'Timestamp';
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
						if( i == 0){
							tmpTS = rowData[0];
							outData1[dataIdx] = [];
							outData2[dataIdx] = [];
							outData1[dataIdx].push(tmpTS);
							outData2[dataIdx].push(tmpTS);
						}						
						if (tmpTS.localeCompare(rowData[0]) !== 0){
							firstSet = false;
							tmpTS = rowData[0];
							prevRow1 = outData1[dataIdx];
							prevRow2 = outData2[dataIdx];
							dataIdx++;
							outData1[dataIdx] = [];
							outData2[dataIdx] = [];							
							outData1[dataIdx].push(tmpTS);
							outData2[dataIdx].push(tmpTS);							
						}						
						if (firstSet){
							hdrData[hdrIdx++] = rowData[1];
						}
							outData1[dataIdx].push(Number(rowData[2]));
							outData2[dataIdx].push(Number(rowData[3]));
                    }
                }
				var difData1 = [];
				var difData2 = [];
				for(var k = 1; k < outData1.length; k++){
					difData1[k-1] = [];
					difData1[k-1].push(outData1[k-1][0]);
					difData2[k-1] = [];
					difData2[k-1].push(outData2[k-1][0]);
					for(var j = 1; j < hdrData.length; j++){
						difData1[k-1].push(outData1[k][j] - outData1[k-1][j]);
						difData2[k-1].push(outData2[k][j] - outData2[k-1][j]);
					}
				}				
				outData.push([ hdrData , difData1, difData2 ]);
                return outData;
            }			
            //----------------------------------------------------------------
            function parseIOFileStatsData(inputData) {
                var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var rowData = [];
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        outData.push([rowData[0], rowData[1], Number(rowData[2]),Number(rowData[3])]);
                    }
                }
                return outData;
            }						
            //----------------------------------------------------------------
			function drawBasicCharts(){
				preDraw();	
				drawIOFunctionStatsChart();
				drawIOFileStatsChart();
			}
			//----------------------------------------------------------------
            //------io function stats
            function drawIOFunctionStatsChart() {
                			
				var drawRegionMb = "iofunctionstatsmbregion";
				var drawRegionRq = "iofunctionstatsrqregion";
				var ioFunctionStatsQuery = "select snapTime,functionName, sum(mb) as tmb, sum(rq) as trq from ( "+
					"select snapTime, functionName,(srmb+swmb+lrmb+lwmb) mb,  (srrq+swrq+lrrq+lwrq) rq "+
					"from iofunctionstats_buffer "+
					"where dbuniquename='"+dbUniqueName+"' and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"'"+
					") group by snapTime,functionName order by snapTime,functionName";
				//alert(ioFunctionStatsQuery);
				var allData = parseIOFunctionStatsData(getData(ioFunctionStatsQuery));
				var dataMb = allData[0][1];
				var dataRq = allData[0][2];
				var tblHeader = allData[0][0];
                var dtMb = new google.visualization.DataTable();
				var dtRq = new google.visualization.DataTable();
				dtMb.addColumn('string', 'Time');
				dtRq.addColumn('string', 'Time');
				for (var i = 1; i < tblHeader.length; i++){
						dtMb.addColumn('number',tblHeader[i]);
						dtRq.addColumn('number',tblHeader[i]);
				}
				
                dtMb.addRows(dataMb); 
				dtRq.addRows(dataRq); 

                var IOFunctionStatsMbChart = new google.visualization.ColumnChart(document.getElementById(drawRegionMb));
                var options = {
                    title: 'IO Stats by function (Mb)',
                    width: 1800,
                    height: 500,
                    hAxis: {textPosition: 'none'},
                    vAxis: {minValue: 0, format: '####'},
                    animation: {startup: 'true', duration: 300},
                    bars: 'vertical',
                    //orientation : 'vertical',
                    bar: {groupWidth: '95%'},
                    legend: {position: 'none'},
                    isStacked: true,
                    backgroundColor: {fill: 'transparent'}
                };				
				var IOFunctionStatsRqChart = new google.visualization.ColumnChart(document.getElementById(drawRegionRq));
                IOFunctionStatsMbChart.draw(dtMb, options);
                var options = {
                    title: 'IO Stats by function (requests)',
                    width: 1800,
                    height: 500,
                    hAxis: {textPosition: 'none'},
                    vAxis: {minValue: 0, format: '####'},
                    animation: {startup: 'true', duration: 300},
                    bars: 'vertical',
                    //orientation : 'vertical',
                    bar: {groupWidth: '95%'},
                    legend: {position: 'none'},
                    isStacked: true,
                    backgroundColor: {fill: 'transparent'}
                };				
				IOFunctionStatsRqChart.draw(dtRq, options);
                //--Register Events 
                //--
                /*
                function sysStatsSelectHandler(e) {
                    if (sysStatsChart.getSelection().length === 0) {
                        if (typeof sesStatsChart !== 'undefined') {
                            sesStatsChart.clearChart();
                        }
                    } else {
                        var sel = sysStatsChart.getSelection();
                        drawSesStatsChart(sel[0].column);
                        document.getElementById('sesstatsregion').scrollIntoView();
                    }
                }
                
                google.visualization.events.addListener(sysStatsChart, 'select', sysStatsSelectHandler);
                */
            }
			//------io function stats
		//--------------------------------------------------------------
		function drawIOFileStatsChart(){
				return;
				var drawRegion = "iofilestatsregion";
				var ioFileStatsQuery = "select snapTime,functionName, sum(mb) as tmb, sum(rq) as trq from ( "+
					"select snapTime, functionName,(srmb+swmb+lrmb+lwmb) mb,  (srrq+swrq+lrrq+lwrq) rq "+
					"from iofunctionstats_buffer "+
					"where dbuniquename='"+dbUniqueName+"' and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"'"+
					") group by snapTime,functionName order by snapTime,functionName";
				//alert(ioFileStatsQuery);
                var data = new google.visualization.DataTable();
                data.addColumn( 'string', 'Time' );
                data.addColumn( 'number', 'Value' );
				//alert(parseIOFileStatsData(getData(ioFileStatsQuery)));
				return;
                data.addRows(parseIOFileStatsData(getData(ioFileStatsQuery))); 
                var options = {
                    title: 'IO Stats by file',
                    width: 1800,
                    height: 500,
                    hAxis: {textPosition: 'none'},
                    vAxis: {minValue: 0, format: '####'},
                    animation: {startup: 'true', duration: 300},
                    bars: 'vertical',
                    //orientation : 'vertical',
                    bar: {groupWidth: '95%'},
                    legend: {position: 'none'},
                    isStacked: true,
                    backgroundColor: {fill: 'transparent'}
                };
                var IOFileStatsChart = new google.visualization.ColumnChart(document.getElementById(drawRegion));
                IOFileStatsChart.draw(data, options);
                //--Register Events 
                //--
                /*
                function sysStatsSelectHandler(e) {
                    if (sysStatsChart.getSelection().length === 0) {
                        if (typeof sesStatsChart !== 'undefined') {
                            sesStatsChart.clearChart();
                        }
                    } else {
                        var sel = sysStatsChart.getSelection();
                        drawSesStatsChart(sel[0].column);
                        document.getElementById('sesstatsregion').scrollIntoView();
                    }
                }
                
                google.visualization.events.addListener(sysStatsChart, 'select', sysStatsSelectHandler);
                */
            }		
		//--------------------------------------------------------------
    </script>
  </head>

  <body onLoad=''>
	<div id="iofunctionstatsmbregion"></div>
	<div id="iofunctionstatsrqregion"></div>
	<div id="iofilestatsmbregion"></div>
	<div id="iofilestatsrqregion"></div>
  </body>
</html>

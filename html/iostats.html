<html>
  <head>
	<meta charset="utf-8">
	<style></style>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
            google.charts.load('current', {'packages': ['corechart']});
            //google.charts.load('current', {'packages': ['table']});
            //google.charts.load('current', {'packages':['bar']});
            google.charts.setOnLoadCallback(drawIOCharts);
            //--
            function getData(query) {
                var xmlHttp = new XMLHttpRequest();
                var xmlHttpOutput;
                xmlHttp.open("POST", 'http://apex.gksm.local:18123/ckh/?database=oradb&user=oracle&password=elcaro&query=', false);
                xmlHttp.send(query);
                return xmlHttp.responseText;
            }
            //--            
            var ts;
            var te;
            var timeSpan1;
            var timeSpan2;
            //--changable
            var spanMinutes = 5;
            var dbUniqueName = 'sefarm_prd';
            //--------------------------------------------------------------
            function preDraw() {
                te = new Date();
                ts = new Date(te.getTime() - 1000 * 60 * spanMinutes);
                timeSpan1 = ts.getFullYear() + '-' +
                        ("0" + (ts.getMonth() + 1)).slice(-2) + '-' + ("0" + ts.getDate()).slice(-2)
                        + ' ' +
                        ("0" + ts.getHours()).slice(-2) + ':' + ("0" + ts.getMinutes()).slice(-2) + ':' + ("0" + ts.getSeconds()).slice(-2)
                        ;
                timeSpan2 = te.getFullYear() + '-' +
                        ("0" + (te.getMonth() + 1)).slice(-2) + '-' + ("0" + te.getDate()).slice(-2)
                        + ' ' +
                        ("0" + te.getHours()).slice(-2) + ':' + ("0" + te.getMinutes()).slice(-2) + ':' + ("0" + te.getSeconds()).slice(-2)
                        ;
            }
            //----------------------------------------------------------------
			var countBufferCache = 'N';
			//var IOFunctionStatsDetailMbChart;
			//var IOFunctionStatsDetailRqChart;
            //----------------------------------------------------------------
			function drawIOCharts(){
				preDraw();	
				drawIOFunctionStatsChart();
				drawIOFileStatsChart();
			}
			//----------------------------------------------------------------            
            function parseIOFunctionStatsData(inputData) {
                var dataLines = inputData.split(/[\n]+/);
                var outData1 = [];
				var outData2 = [];
				var outData  = [];
                var rowData = [];
				var hdrData = [];
				var tmpTS = "";
				var hdrIdx = 1;
				var dataIdx = 0;
				var firstSet = true;
				var prevRow1 = [];
				var prevRow2 = [];
				hdrData[0] = 'Timestamp';
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
						if( i == 0){
							tmpTS = rowData[0];
							outData1[dataIdx] = [];
							outData2[dataIdx] = [];
							outData1[dataIdx].push(tmpTS);
							outData2[dataIdx].push(tmpTS);
						}						
						if (tmpTS.localeCompare(rowData[0]) !== 0){
							firstSet = false;
							tmpTS = rowData[0];
							prevRow1 = outData1[dataIdx];
							prevRow2 = outData2[dataIdx];
							dataIdx++;
							outData1[dataIdx] = [];
							outData2[dataIdx] = [];							
							outData1[dataIdx].push(tmpTS);
							outData2[dataIdx].push(tmpTS);							
						}						
						if (firstSet){
							hdrData[hdrIdx++] = rowData[1];
						}
							outData1[dataIdx].push(Number(rowData[2]));
							outData2[dataIdx].push(Number(rowData[3]));
                    }
                }
				var difData1 = [];
				var difData2 = [];
				for(var k = 1; k < outData1.length; k++){
					difData1[k-1] = [];
					difData1[k-1].push(outData1[k-1][0]);
					difData2[k-1] = [];
					difData2[k-1].push(outData2[k-1][0]);
					for(var j = 1; j < hdrData.length; j++){
						difData1[k-1].push(outData1[k][j] - outData1[k-1][j]);
						difData2[k-1].push(outData2[k][j] - outData2[k-1][j]);
					}
				}				
				outData.push(hdrData);
				outData.push(difData1);
				outData.push(difData2);
                return outData;
            }			
            //----------------------------------------------------------------
            function parseIOFunctionStatsDetails(inputData){
               var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var outData1 = [];
                var outData2 = [];
                var rowData = [];
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        outData1.push([rowData[0], Number(rowData[1]), Number(rowData[2]),Number(rowData[3]),Number(rowData[4])]);
                        outData2.push([rowData[0], Number(rowData[5]), Number(rowData[6]),Number(rowData[7]),Number(rowData[8])]);
                    }
                }
                outData.push(outData1);
                outData.push(outData2);
                return outData;				
			}
            //----------------------------------------------------------------
            function parseIOFileStatsData(inputData) {
                var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var rowData = [];
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        outData.push([rowData[0], rowData[1], Number(rowData[2]),Number(rowData[3])]);
                    }
                }
                return outData;
            }						
            //----------------------------------------------------------------

            //------io function stats
            function drawIOFunctionStatsChart() {
                			
				var drawRegionMb = "iofunctionstatsmbregion";
				var drawRegionRq = "iofunctionstatsrqregion";
				var ioFunctionStatsQuery = "select snapTime,functionName, sum(mb) as tmb, sum(rq) as trq from ( "+
					"select snapTime, functionName,(srmb+swmb+lrmb+lwmb) mb,  (srrq+swrq+lrrq+lwrq) rq "+
					"from iofunctionstats_buffer "+
					"where dbuniquename='"+dbUniqueName+"' and snapTime>='"+timeSpan1+"' and snapTime<='"+timeSpan2+"'"+
					((countBufferCache == 'Y')? "" : " and functionName<>'Buffer Cache Reads' ")+
					") group by snapTime,functionName order by snapTime,functionName";
				//alert(ioFunctionStatsQuery);
				var allData = parseIOFunctionStatsData(getData(ioFunctionStatsQuery));
				var tblHeader = allData[0];
				var dataMb = allData[1];
				var dataRq = allData[2];
                var dtMb = new google.visualization.DataTable();
				var dtRq = new google.visualization.DataTable();
				dtMb.addColumn('string', 'Time');
				dtRq.addColumn('string', 'Time');
				for (var i = 1; i < tblHeader.length; i++){
						dtMb.addColumn('number',tblHeader[i]);
						dtRq.addColumn('number',tblHeader[i]);
				}
				
                dtMb.addRows(dataMb); 
				dtRq.addRows(dataRq); 

                var IOFunctionStatsMbChart = new google.visualization.ColumnChart(document.getElementById(drawRegionMb));
                var options = {
                    title: 'IO Stats by function (Mb)',
                    width: 1800,
                    height: 500,
                    hAxis: {textPosition: 'none'},
                    vAxis: {minValue: 0, format: '####'},
                    animation: {startup: 'true', duration: 300},
                    bars: 'vertical',
                    //orientation : 'vertical',
                    bar: {groupWidth: '95%'},
                    legend: {position: 'right'},
                    isStacked: true,
                    backgroundColor: {fill: 'transparent'}
                };				
				var IOFunctionStatsRqChart = new google.visualization.ColumnChart(document.getElementById(drawRegionRq));
                IOFunctionStatsMbChart.draw(dtMb, options);
                var options = {
                    title: 'IO Stats by function (requests)',
                    width: 1800,
                    height: 500,
                    hAxis: {textPosition: 'none'},
                    vAxis: {minValue: 0, format: '####'},
                    animation: {startup: 'true', duration: 300},
                    bars: 'vertical',
                    //orientation : 'vertical',
                    bar: {groupWidth: '95%'},
                    legend: {position: 'right'},
                    isStacked: true,
                    backgroundColor: {fill: 'transparent'}
                };				
				IOFunctionStatsRqChart.draw(dtRq, options);
                //--Register Events 
                function IOFunctionStatsMbHandler(e) {
                    var sel = IOFunctionStatsMbChart.getSelection();
                    drawIOFunctionStatsDetailsChart(tblHeader[sel[0].column]);
                }                
                google.visualization.events.addListener(IOFunctionStatsMbChart, 'select', IOFunctionStatsMbHandler);
                function IOFunctionStatsRqHandler(e) {
                    var sel = IOFunctionStatsRqChart.getSelection();
                    drawIOFunctionStatsDetailsChart(tblHeader[sel[0].column]);
                }                
                google.visualization.events.addListener(IOFunctionStatsRqChart, 'select', IOFunctionStatsRqHandler);                
            }
			//------io function stats
			//------io function stats details
			function drawIOFunctionStatsDetailsChart(functionName) {
				var drawRegionDetailsMb = "iofunctionstatsmbdetailsregion";
				var drawRegionDetailsRq = "iofunctionstatsrqdetailsregion";
				var ioFunctionStatsDetailsQuery  = "select * from ( "+
					"select snapTime, "+
						"runningDifference(srmb), runningDifference(swmb), runningDifference(lrmb), runningDifference(lwmb),"+
						"runningDifference(srrq),runningDifference(swrq),runningDifference(lrrq),runningDifference(lwrq) "+
						"from ( "+
							"select snapTime, "+
							"sum(srmb) as srmb,sum(swmb) as swmb,sum(lrmb) as lrmb,sum(lwmb) as lwmb,"+
							"sum(srrq) as srrq,sum(swrq) as swrq,sum(lrrq) as lrrq,sum(lwrq) as lwrq "+
							"from iofunctionstats_buffer "+
							"where dbuniquename='"+dbUniqueName+"' and snapTime>=(select max(snapTime) from iofunctionstats_buffer where "+
							"dbuniquename='"+dbUniqueName+"' and snapTime < '"+timeSpan1+"') "+
							"and snapTime<='"+timeSpan2+"' and functionName='"+functionName+"' group by snapTime order by snapTime"+
						") "+
					") where snapTime>='"+timeSpan1+"' order by snapTime";
				//alert(ioFunctionStatsDetailsQuery);
				var dataMb = new google.visualization.DataTable();
				var dataRq = new google.visualization.DataTable();
                dataMb.addColumn( 'string', 'Time' );
                dataMb.addColumn( 'number', 'Small Read' );
                dataMb.addColumn( 'number', 'Small Write' );
                dataMb.addColumn( 'number', 'Large Read' );
                dataMb.addColumn( 'number', 'Large Write' );
                dataRq.addColumn( 'string', 'Time' );
                dataRq.addColumn( 'number', 'Small Read' );
                dataRq.addColumn( 'number', 'Small Write' );
                dataRq.addColumn( 'number', 'Large Read' );
                dataRq.addColumn( 'number', 'Large Write' );
                var allData = parseIOFunctionStatsDetails(getData(ioFunctionStatsDetailsQuery));
                dataMb.addRows(allData[0]); 
                dataRq.addRows(allData[1]); 
                var options = {
                    title: 'IO Function Details (Mb): '+functionName+'',
                    width: 1800,
                    height: 500,
                    hAxis: {textPosition: 'none'},
                    vAxis: {minValue: 0, format: '####'},
                    animation: {startup: 'true', duration: 300},
                    bars: 'vertical',
                    //orientation : 'vertical',
                    bar: {groupWidth: '95%'},
                    legend: {position: 'right'},
                    isStacked: true,
                    backgroundColor: {fill: 'transparent'}
                };
                var IOFunctionStatsDetailMbChart = new google.visualization.ColumnChart(document.getElementById(drawRegionDetailsMb));
                IOFunctionStatsDetailMbChart.draw(dataMb, options);								
                var options = {
                    title: 'IO Function Details (requests): '+functionName+'',
                    width: 1800,
                    height: 500,
                    hAxis: {textPosition: 'none'},
                    vAxis: {minValue: 0, format: '####'},
                    animation: {startup: 'true', duration: 300},
                    bars: 'vertical',
                    //orientation : 'vertical',
                    bar: {groupWidth: '95%'},
                    legend: {position: 'right'},
                    isStacked: true,
                    backgroundColor: {fill: 'transparent'}
                };                
                var IOFunctionStatsDetailRqChart = new google.visualization.ColumnChart(document.getElementById(drawRegionDetailsRq));
                IOFunctionStatsDetailRqChart.draw(dataRq, options);	                
			}
			//------io function stats details
		//--------------------------------------------------------------
		function drawIOFileStatsChart(){
				return;
        }		
		//--------------------------------------------------------------
    </script>
  </head>

  <body onLoad=''>
	<div id="iofunctionstatsmbregion"></div>
	<div id="iofunctionstatsmbdetailsregion"></div>
	<div id="iofunctionstatsrqregion"></div>
	<div id="iofunctionstatsrqdetailsregion"></div>
	<div id="iofilestatsmbregion"></div>
	<div id="iofilestatsrqregion"></div>
  </body>
</html>

<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <meta charset="utf-8">
        <title>ClickHouse Graphs</title>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script type="text/javascript">
            google.charts.load('current', {'packages': ['corechart']});
            google.charts.setOnLoadCallback(drawSessStatsChart);
            var arrWaitClass = [
                'Timestamp',
                'System I/O',
                'User I/O',
                'Commit',
                'Network',
                'CPU',
                'Administrative',
                'Concurrency',
                'Application',
                'Configuration',
                'Queueing',
                'Scheduler',
                'Other'
            ];
            var arrWaitClassStyle = [
                '',
                'DeepSkyBlue',
                'Blue',
                'Orange',
                'Moccasin',
                'LimeGreen',
                'Silver',
                'DarkRed',
                'Red',
                'Sienna',
                'MistyRose',
                'PaleGreen',
                'Magenta'
            ];
            var arrClassNum = [12, 8, 9, 6, 7, 3, 0, 4, 2, 1, 11, 10];
            arrClassNum[127] = 5;
            //--
            var ts;
            var te;
            var timeSpan1;
            var timeSpan2;
            //--changable
            var spanMinutes = 10;
            var dbUniqueName = 'sefarm_prd';
            var loadimg = "circle.gif";
            var statName = "redo size";
            //--------------------------------------------------------------
            function preDraw() {
                te = new Date();
                ts = new Date(te.getTime() - 1000 * 60 * spanMinutes);
                timeSpan1 = ts.getFullYear() + '-' +
                        ("0" + (ts.getMonth() + 1)).slice(-2) + '-' + ("0" + ts.getDate()).slice(-2)
                        + ' ' +
                        ("0" + ts.getHours()).slice(-2) + ':' + ("0" + ts.getMinutes()).slice(-2) + ':' + ("0" + ts.getSeconds()).slice(-2)
                        ;
                timeSpan2 = te.getFullYear() + '-' +
                        ("0" + (te.getMonth() + 1)).slice(-2) + '-' + ("0" + te.getDate()).slice(-2)
                        + ' ' +
                        ("0" + te.getHours()).slice(-2) + ':' + ("0" + te.getMinutes()).slice(-2) + ':' + ("0" + te.getSeconds()).slice(-2)
                        ;
            }
            //------SESSSTATS
            function drawSessStatsChart() {
                preDraw();				
				var drawRegion = "sessstatsregion";
                var sessstatsQuery = "select snapTime ,cvl,ivl from (" +
						"select snapTime,sum(value) as cvl, 1 as jn from sesstats_buffer where dbuniquename='"+dbUniqueName+"' and statName='"+statName+
                        "' and snapTime >= '" + timeSpan1 + "' and snapTime <= '" + timeSpan2 + 
                        "' group by snapTime) all left join ("+
							"select sum(value) as ivl, 1 as jn from sesstats_buffer where dbuniquename='"+dbUniqueName+"' and statName= '"+statName+"' and snapTime=("+
								"select max(snapTime) from sesstats_buffer where dbuniquename='"+dbUniqueName+"' and statName= '"+statName+"' and snapTime < '"+timeSpan1 +"'"+
							")"+
                        ") using jn order by snapTime asc";
                //alert(sessstatsQuery);
                var data = new google.visualization.DataTable();
                //--add Columns
                data.addColumn('string', 'Timestamp');
                data.addColumn('number', 'Data');
                data.addColumn({type: 'string', role: 'tooltip'});
                //-- add Data
                data.addRows(parseSessStatsData(getData(sessstatsQuery)));
                var options = {
                    title: 'Sessions Statistics',
                    width: 1800,
                    height: 800,
                    hAxis: {textPosition: 'none'},
                    vAxis: {minValue: 0, format: '####'},
                    animation: {startup: 'true', duration: 1000},
                    bars: 'vertical',
                    //orientation : 'vertical',
                    bar: {groupWidth: '95%'},
                    legend: {position: 'none', maxLines: 3},
                    isStacked: true,
                    backgroundColor: {fill: 'transparent'}
                };
                var sessstatsChart = new google.visualization.ColumnChart(document.getElementById(drawRegion));
                sessstatsChart.draw(data, options);
            }
            //------SESSSTATS        
            //--
            function getData(query) {
                var xmlHttp = new XMLHttpRequest();
                var xmlHttpOutput;
                xmlHttp.open("POST", 'http://10.64.139.57:18123/?database=oradb&query=', false); // false for synchronous request
                xmlHttp.send(query);
                return xmlHttp.responseText;
            }
            //--
            function parseSessStatsData(inputData) {
                var dataLines = inputData.split(/[\n]+/);
                var outData = [];
                var tmpData = [];
                var rowData = [];
                var idx;
                var previdx;
                for (var i = 0; i < dataLines.length; i++) {
                    if (dataLines[i].length > 0) {
                        rowData = dataLines[i].split(/[\t]+/);
                        idx = Number(rowData[0].replace(/[:-\s]/g, ""));
                        if (typeof tmpData[idx] === 'undefined') {
							if ( i === 0 ){
								tmpData[idx] = [rowData[0], Number(rowData[1])-Number(rowData[2]),rowData[0]];
							}else{
								tmpData[idx] = [rowData[0], Number(rowData[1])-Number(tmpData[previdx][1]),rowData[0]];
							}
							
                        }
                        previdx=idx;
                    }
                }
                for (var wi in tmpData) {
                    outData.push(tmpData[wi]);
                }
                return outData;
            }
            //--
        </script>
    </head>

    <body onLoad=''>
        <div id="sessstatsregion"></div>
    </body>
</html>
